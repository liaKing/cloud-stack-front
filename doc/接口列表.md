# 投壶股票系统 - 接口列表

> 基于 [实现方案（后端）](./实现方案（后端）.md) 整理。基础路径假设为 `/api`（按实际部署可加前缀）。  
> ID 与前端统一使用 string，时间统一时间戳（BIGINT）。

---

## 一、用户模块

| 方法 | 路径 | 鉴权 | 说明 |
|------|------|------|------|
| POST | /user/login | 否 | 登录 |
| GET | /user/userInfo | 否 | 获取用户信息（Query: userId） |
| POST | /user/admin/register | Admin | 管理员注册用户 |
| POST | /user/admin/del | Admin | 管理员删除用户 |
| POST | /user/admin/doluck | Admin | 管理员增减用户幸运值（正数增加，负数减少） |

---

## 二、项目（物品）与官方出售

### 2.1 管理端 - 项目

| 方法 | 路径 | 鉴权 | 说明 |
|------|------|------|------|
| POST | /admin/item/batch | Admin | 批量创建/更新项目。Body：项目列表，每项含 name、description、purchase_price；新建时初始化 total_value、total_quantity（如每股 1 幸运值）。 |
| POST | /admin/item/abolish | Admin | **废除项目（数量不足时调用）**。传入 itemId；对该项目下所有 stock_user 按约定单价（如每股 1 幸运值）退 luck 到 user.luck，将 item.status 置为已淘汰，可选清零该项目的 stock_user。 |

**废除项目请求示例（K2S）**

```json
{
  "itemId": "项目ID"
}
```

**批量创建/更新项目请求示例（K2S）**

```json
{
  "items": [
    { "name": "物品A", "description": "描述", "purchasePrice": 10 },
    { "name": "物品B", "description": "描述", "purchasePrice": 10 }
  ]
}
```

### 2.2 观众端 - 官方出售（仅立项中可购买）

| 方法 | 路径 | 鉴权 | 说明 |
|------|------|------|------|
| PUT | /stock/buy | 登录 | 从官方购买项目股票。仅当项目 status = 立项中 时可购买。扣用户 luck，增 stock_user，更新 item 的 total_quantity/total_value。与交易大厅隔离。 |

**请求示例（K2S）**

```json
{
  "itemId": "项目ID",
  "quantity": 10
}
```

### 2.3 观众端 - 项目与持仓查询

| 方法 | 路径 | 鉴权 | 说明 |
|------|------|------|------|
| GET | /stock/item/list | 登录 | 获取项目列表（可分页）。Query：pageNum、pageSize、status（可选）。 |
| GET | /stock/user | 登录 | 获取当前用户持仓列表（stock_user，按 item 维度）。 |

---

## 三、交易大厅（/trade）

所有接口需登录；与官方出售 `/stock/buy` 完全分离。

| 方法 | 路径 | 鉴权 | 说明 |
|------|------|------|------|
| PUT | /trade/sell | 登录 | 挂卖单。扣减本人该 item 持仓，写入 order（order_type=卖单）。 |
| PUT | /trade/buy | 登录 | 挂买单。写入 order（order_type=买单）；按实现可预扣 luck 或应单时再扣。 |
| GET | /trade/orders | 登录 | 挂单列表（分页）。Query：itemId、orderType（1 卖/2 买）、priceMin、priceMax、pageNum、pageSize。 |
| PUT | /trade/accept | 登录 | 应单。对卖单：买家应单扣 luck、增持仓；对买单：卖家应单扣持仓、买家扣 luck。Body：orderId、quantity。 |
| PUT | /trade/cancel | 登录 | 撤销自己的挂单。卖单退还 quantity 到 stock_user；买单按实现退还 luck（若预扣）。 |

**挂卖单请求示例（K2S）**

```json
{
  "itemId": "项目ID",
  "price": 5,
  "quantity": 100
}
```

**挂买单请求示例（K2S）**

```json
{
  "itemId": "项目ID",
  "price": 4,
  "quantity": 50
}
```

**应单请求示例（K2S）**

```json
{
  "orderId": "挂单ID",
  "quantity": 20
}
```

---

## 四、投壶与价格计算（管理端）

| 方法 | 路径 | 鉴权 | 说明 |
|------|------|------|------|
| POST | /admin/throw/submit | Admin | 提交一次投壶。写 throw_record + throw_hit，并按公式更新所有项目的 item.total_value。单项目收益 = player_pay / total_items；每项目 new_total_value = old_total_value + 单项目收益 - purchase_price × hit_count（未出现在 hits 中的项目 hit_count=0）。 |

**请求示例（K2S）**

```json
{
  "playerPay": 10,
  "totalItems": 10,
  "hits": [
    { "itemId": "项目A ID", "hitCount": 1 },
    { "itemId": "项目B ID", "hitCount": 2 }
  ]
}
```

---

## 五、每日结算（管理端）

| 方法 | 路径 | 鉴权 | 说明 |
|------|------|------|------|
| POST | /admin/settlement/daily | Admin | 触发当日结算。按项目逐个：每股价值 = item.total_value / item.total_quantity；对该项目下所有 stock_user 退还 每股价值 × quantity 到 user.luck；可选清零/归档持仓、写结算明细。 |

**请求（K2S）**

- 可无 body 或传 `{ "date": "可选，结算日期时间戳或日期" }` 用于幂等/对账。

---

## 六、接口汇总表（按模块）

| 模块 | 方法 | 路径 | 鉴权 |
|------|------|------|------|
| 用户 | POST | /user/login | 否 |
| 用户 | GET | /user/userInfo | 否 |
| 用户 | POST | /user/admin/register | Admin |
| 用户 | POST | /user/admin/del | Admin |
| 用户 | POST | /user/admin/doluck | Admin |
| 项目/官方出售 | POST | /admin/item/batch | Admin |
| 项目/官方出售 | POST | /admin/item/abolish | Admin |
| 项目/官方出售 | PUT | /stock/buy | 登录 |
| 项目/官方出售 | GET | /stock/item/list | 登录 |
| 项目/官方出售 | GET | /stock/user | 登录 |
| 交易大厅 | GET | /trade/records | 登录 |
| 交易大厅 | PUT | /trade/sell | 登录 |
| 交易大厅 | PUT | /trade/buy | 登录 |
| 交易大厅 | GET | /trade/orders | 登录 |
| 交易大厅 | PUT | /trade/accept | 登录 |
| 交易大厅 | PUT | /trade/cancel | 登录 |
| 投壶 | POST | /admin/throw/submit | Admin |
| 结算 | POST | /admin/settlement/daily | Admin |

---

## 七、路由分组建议（与现有 router 对齐）

- `/user`：用户相关，部分子路径加 Admin 中间件。
- `/stock`：官方出售与项目/持仓查询，加登录中间件。
- `/trade`：交易大厅，加登录中间件。
- `/admin/item`、`/admin/throw`、`/admin/settlement`：管理端，加 Admin 中间件（可与现有 `/user/admin` 同策略）。

以上为基于实现方案整理的接口列表，可按需补充请求/响应码、错误码表或 OpenAPI 导出。

---

## 八、接口实现情况（与当前代码对齐）

本接口列表已与当前项目 router、handler、service 对照并完成修正：

- **用户**：登录、获取用户信息（GET /user/userInfo?userId=）、管理员注册/删除/增减幸运值均已实现。
- **项目与官方出售**：管理端 item/batch、item/abolish；观众端 /stock/buy、/stock/item/list、/stock/user 均已实现。
- **交易大厅**：/trade/sell、/trade/buy、/trade/orders、/trade/accept、/trade/cancel、/trade/records 均已实现。
- **管理端**：/admin/throw/submit、/admin/settlement/daily 均已实现。

路由分组与 router.go 一致：`/user`、`/stock`（JWT）、`/trade`（JWT）、`/admin`（JWT + Admin）。
