# 投壶股票系统 - 前端实现方案

> 基于 [产品说明](./product_description.md)、[后端实现方案](./后端实现方案.md) 及 [接口列表](./接口列表.md) 制定。
> 本方案旨在重构现有前端逻辑，适配新的产品玩法（赛前官方出售、赛中交易大厅、投壶价格变动、每日结算）。

---

## 一、 技术选型与架构

### 1.1 技术栈
- **框架**: UniApp (Vue 2) - *沿用现有框架，确保跨平台能力（H5/小程序/App）*
- **UI 组件库**: uView UI (v2) - *沿用现有依赖，快速构建界面*
- **HTTP 请求**: `luch-request` (uView 内置) - *统一拦截器处理 Token 和错误码*
- **状态管理**: Vuex - *管理用户信息、Token、全局配置*

### 1.2 目录结构规划
建议对现有目录进行清理和重组，以适应新业务：

```
/
├── api/                    # API 接口统一管理
│   ├── user.js             # 用户相关
│   ├── stock.js            # 官方股票/项目相关
│   ├── trade.js            # 交易大厅相关
│   └── common.js           # 公共接口
├── components/             # 公共组件
│   ├── stock-card.vue      # 股票/项目卡片（展示价格、涨跌幅）
│   ├── trade-action.vue    # 交易操作弹窗（买入/卖出/挂单）
│   └── price-chart.vue     # (可选) 价格走势图
├── store/                  # Vuex 状态管理
│   ├── modules/
│   │   ├── user.js         # 用户信息、资产
│   │   └── market.js       # 市场行情缓存（可选）
│   └── index.js
├── pages/                  # 页面文件
│   ├── index/              # 首页（官方申购/赛前准备）
│   ├── hall/               # 交易大厅（P2P 交易）
│   ├── assets/             # 我的持仓
│   ├── mine/               # 个人中心
│   └── login/              # 登录页
└── utils/
    ├── request.js          # 请求封装
    └── util.js             # 工具函数 (时间格式化、数值计算)
```

---

## 二、 核心业务流程与页面设计

### 2.1 底部导航栏 (Tabbar) 规划
1.  **首页 (官方市场)**: 展示 10 个项目，赛前申购入口。
2.  **大厅 (交易市场)**: 玩家之间的挂单列表，自由交易。
3.  **持仓 (我的资产)**: 当前持有的股票、幸运值余额、交易记录。
4.  **我的**: 个人信息、设置、管理员入口（如果有权限）。

---

### 2.2 详细页面功能设计

#### 1. 首页 - 官方申购 (Official Market)
*对应阶段：赛前准备*

-   **核心展示**: 
    -   10 个项目的列表（Grid 或 List 布局）。
    -   每个项目展示：名称、描述、**进货价**、**官方当前总价**、**当前总股数**、**每股估值**。
    -   状态标识：`立项中`、`游戏中`、`已淘汰`。
-   **交互**:
    -   **申购**: 点击项目 -> 弹出购买框 -> 输入数量 -> 调用 `PUT /stock/buy`。
    -   **实时性**: 下拉刷新 + 轮询 (每 10s) 更新项目状态和剩余数量，特别是关注“立项中”到“游戏中”的状态切换。
    -   **淘汰展示**: 若项目状态变为 `已淘汰`，显示置灰并在 UI 上注明“已废除/资金已退回”。

#### 2. 交易大厅 (Trading Hall)
*对应阶段：进行中*

-   **核心展示**:
    -   **筛选区**: 全部项目/指定项目筛选、买单/卖单切换。
    -   **挂单列表**: 展示 `trade_order` 数据（价格、数量、剩余量）。
    -   **行情看板**: 顶部展示 10 个项目当前的**最新成交价**或**官方指导价**（基于投壶结果变动）。
-   **交互**:
    -   **挂单 (发布交易)**: 
        -   FAB (悬浮按钮) "我要买入" / "我要卖出"。
        -   表单：选择项目、输入价格、输入数量 -> 调用 `PUT /trade/buy` 或 `PUT /trade/sell`。
    -   **应单 (吃单)**:
        -   点击列表中的某个挂单 -> 弹出详情 -> 输入成交数量 -> 调用 `PUT /trade/accept`。
    -   **我的挂单**: 单独 Tab 或入口，查看我当前挂出的单子，支持 **撤单** (`PUT /trade/cancel`)。

#### 3. 我的持仓 (My Assets)
*对应阶段：全阶段*

-   **核心展示**:
    -   **总资产卡片**: 幸运值余额、预估持仓总价值。
    -   **持仓列表**: 我持有的项目、持仓数量、当前每股价值（参考官方价或市场价）。
    -   **交易记录入口**: 跳转至“交易明细”页面，调用 `/trade/records` 展示历史成交。
-   **交互**:
    -   点击持仓条目 -> 快速跳转到“交易大厅”并预填卖出单。
    -   **投壶影响反馈**: 列表需要定时刷新，因为投壶结果会改变“每股价值”，用户需要看到资产的实时变动。

#### 4. 管理员面板 (Admin Panel - 仅特定用户可见)
*建议做成独立分包或通过 `mine` 页面的隐藏入口进入*

-   **投壶录入**: 
    -   表单：输入 `playerPay` (玩家付费), 选择 `hit` (命中的项目及次数) -> 提交 `POST /admin/throw/submit`。
-   **结算触发**: 
    -   按钮：手动触发每日结算 `POST /admin/settlement/daily`。
-   **项目管理**: 
    -   列表管理、废除项目 `POST /admin/item/abolish`。

---

## 三、 数据流与状态同步策略

由于后端目前未明确 WebSocket 支持，前端采用 **短轮询 (Polling) + 用户主动刷新** 策略。

### 3.1 价格与行情同步
*   **场景**: 投壶结束后，项目总价值变动。
*   **策略**: 
    *   在“首页”和“大厅”页面，使用 `setInterval` 每 5-10 秒静默调用 `GET /stock/list` 获取最新官方价值。
    *   当用户在“大厅”浏览挂单时，下拉刷新触发 `GET /trade/orders`。

### 3.2 资产同步
*   **场景**: 交易成交、投壶导致价值变化、结算退款。
*   **策略**: 
    *   每次用户执行“交易操作”（买/卖/撤单）成功后，立即刷新“用户资产”接口 `GET /user/get` 和“持仓列表” `GET /stock/user`。
    *   进入“我的”页面时，强制刷新一次资产。

---

## 四、 接口对接计划 (API Mapping)

| 页面/模块 | 操作 | 对应 API 路径 | 备注 |
| :--- | :--- | :--- | :--- |
| **登录** | 登录 | `POST /user/login` | 存 Token 到 Storage |
| **首页** | 获取项目列表 | `GET /stock/list` | 需新增/统一此接口，展示 item 信息 |
| **首页** | 官方申购 | `PUT /stock/buy` | 仅 `status=立项中` 可用 |
| **资产** | 获取持仓 | `GET /stock/user` | |
| **资产** | 获取余额 | `POST /user/get` | 获取 luck 字段 |
| **大厅** | 挂买单 | `PUT /trade/buy` | |
| **大厅** | 挂卖单 | `PUT /trade/sell` | |
| **大厅** | 市场挂单列表 | `GET /trade/orders` | 支持筛选 |
| **大厅** | 应单(成交) | `PUT /trade/accept` | |
| **大厅** | 撤单 | `PUT /trade/cancel` | |
| **资产** | 交易记录 | `GET /trade/records` | 新增接口，展示买卖明细 |
| **Admin** | 提交投壶 | `POST /admin/throw/submit` | |
| **Admin** | 每日结算 | `POST /admin/settlement/daily` | |

---

## 五、 开发实施步骤

1.  **环境清理 & 基础建设**:
    *   清理旧的页面逻辑（保留 User 相关）。
    *   封装 `request.js` 对接新后端 API 规范 (统一 Header, Error Handle)。
    *   建立 Vuex Store 结构。

2.  **第一阶段: 官方市场 (Pre-game)**:
    *   开发 `pages/index/index.vue`。
    *   实现项目列表展示、下拉刷新。
    *   实现 `StockCard` 组件。
    *   实现申购功能对接。

3.  **第二阶段: 交易大厅 (In-game)**:
    *   开发 `pages/hall/index.vue`。
    *   实现挂单列表 (Tabs: 买单/卖单)。
    *   实现“挂单弹窗”组件 (包含价格、数量输入)。
    *   实现“应单”逻辑。

4.  **第三阶段: 资产与结算**:
    *   开发 `pages/assets/index.vue`。
    *   展示持仓明细。
    *   联调投壶后的数值变化（通过轮询验证前端展示是否正确更新）。

5.  **第四阶段: 管理员功能 (可选)**:
    *   开发简易的管理入口，用于测试投壶数据录入和结算流程。
