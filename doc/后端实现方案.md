# 投壶股票系统 - 后端实现方案

> 基于 [产品说明](./产品说明.md)，在现有用户模块基础上，给出后端详细实现方案。  
> 技术栈与约定：Gin、GORM、雪花 ID（uint64）、与前端交互 ID 用 string、时间用时间戳（BIGINT）；Controller 层优先调用 Service 层，统一使用 common 链式封装响应。

---

## 一、现状与范围

### 1.1 已有能力（用户模块）

- **实体/表**：`user`（uid、account、name、password、luck 等）
- **模型**：`model.User`、`K2SRegisterUser`、`K2SLoginUser`、`K2SDoLuckUser` 等
- **能力**：登录、获取用户信息、管理员注册/删用户、管理员增减幸运值（doluck）
- **路由**：`/user/*`（部分需 Admin 中间件）

### 1.2 本文档覆盖范围

- 赛前：项目/物品、起始出售与数量增长规则
- 进行中：交易大厅（挂卖单/挂买单、浏览、应单成交）、投壶结果上报与总价值计算
- 每日结束：观众持仓结算与幸运值退还

---

## 二、领域概念与名词统一

| 产品用语     | 后端概念       | 说明 |
|-------------|----------------|------|
| 物品        | 项目/股票项目  | 一个物品 = 一个项目 = 一支“股票” |
| 项目        | item / stock_item | 表：项目 ID、名称、描述、进货价、当前数量、总价值等 |
| 观众持有    | 用户持仓       | 用户在某项目上的股数（stock_user） |
| 交易大厅    | 挂单/订单      | 卖单：观众挂卖单；买单：观众挂寻求买入单；均可被对方应单成交 |
| 每股价值    | 总价值÷股数    | 用于每日结算时给观众退幸运值 |

---

## 三、数据模型与表结构

### 3.1 项目（物品）表 `item`

对应“10 个物品”，每个物品一个项目，官方不持票时由观众持有。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键，雪花 ID |
| name | VARCHAR(255) | 物品/项目名称 |
| description | TEXT | 项目描述 |
| purchase_price | BIGINT | 进货价（幸运值），如 10 |
| total_value | BIGINT | 当前总价值（幸运值），用于算每股价值 |
| total_quantity | BIGINT | 当前总股数（所有观众持有之和） |
| status | TINYINT | 状态：项目立项中、已淘汰、游戏中、已结算等 |
| ctime | BIGINT | 创建时间戳 |
| mtime | BIGINT | 修改时间戳 |

- 起始：每股 1 幸运值，`total_value = total_quantity`（或按首轮出售结果初始化）。
- 赛前规则：当“在售股票总价值 &gt; 进货价”时，该物品数量 +1（可扩展为 `item_quantity` 或沿用 `total_quantity` 视业务选一）。

### 3.2 用户持仓表 `stock_user`（与现有对齐）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键，雪花 ID |
| user_id | BIGINT | 用户 ID（对应用户表主键/业务 ID） |
| item_id | BIGINT | 项目 ID |
| quantity | BIGINT | 持有股数 |
| ctime / mtime | BIGINT | 时间戳 |

- 与现有 `stock_user` 表结构对齐（如当前为 stock_id、stock_number 等，可做一次迁移或别名映射到 item_id、quantity）。

### 3.3 交易大厅挂单表 `order`（或 `trade_order`）

支持卖单与买单双方向：卖家可挂卖单（求售），买家可挂买单（求购）；双方均可浏览并应单成交。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键，雪花 ID |
| order_type | TINYINT | 1=卖单 2=买单 |
| initiator_id | BIGINT | 发起人 user_id（卖单即卖家，买单即买家） |
| item_id | BIGINT | 项目 ID |
| price | BIGINT | 单价（幸运值） |
| quantity | BIGINT | 挂单数量 |
| remaining | BIGINT | 剩余未成交数量（卖单=待卖出，买单=待买入） |
| status | TINYINT | 挂单中/部分成交/完全成交/已撤销 |
| ctime / mtime | BIGINT | 时间戳 |

- **卖单**：发起人持有该 item 的股票，挂出 price、quantity，等待买家应单；应单时扣发起人持仓、加买家持仓，买家扣 luck、发起人加 luck。
- **买单**：发起人挂出期望的 price、quantity，等待卖家应单；应单时扣卖家持仓、加发起人持仓，发起人扣 luck、卖家加 luck。

### 3.4 成交记录表 `trade_record`

记录每笔“观众-观众”成交，便于对账与历史查询。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键，雪花 ID |
| order_id | BIGINT | 挂单 ID |
| buyer_id | BIGINT | 买家 user_id |
| seller_id | BIGINT | 卖家 user_id |
| item_id | BIGINT | 项目 ID |
| quantity | BIGINT | 成交数量 |
| price | BIGINT | 成交单价 |
| total_amount | BIGINT | 总金额（幸运值） |
| ctime | BIGINT | 成交时间戳 |

### 3.5 投壶记录表 `throw_record`

记录玩家每次投壶：管理员上传“玩家花费、投中物品及数量”后，一方面用请求参数更新各项目总价值，一方面落表留痕便于对账与历史查询。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键，雪花 ID |
| player_pay | BIGINT | 玩家付费（幸运值） |
| total_items | INT | 总项目数（如 10），用于算单项目收益 |
| ctime | BIGINT | 时间戳 |

### 3.6 投壶命中明细表 `throw_hit`

某次投壶（对应一条 throw_record）中，各物品被投中的次数，与 throw_record 一起构成完整投壶记录。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键，雪花 ID |
| throw_record_id | BIGINT | 投壶记录 ID |
| item_id | BIGINT | 项目 ID |
| hit_count | INT | 该物品被投中次数 |
| ctime | BIGINT | 时间戳 |

### 3.7 每日结算记录（可选）

若需留痕“每日结束”的结算结果，可增加：

- `settlement_batch`：批次 ID、日期、状态
- `settlement_detail`：user_id、item_id、股数、每股价值、退还幸运值、批次 ID

---

## 四、核心业务流程与接口

### 4.1 赛前准备

- **活动配置**
  - 创建 10 个项目（item），设置名称、描述（description）、进货价；初始 `total_value`、`total_quantity` 按“起始每股 1 幸运值”规则设置（或首轮开售结果写入）。
- **赛前出售（观众购买）**
  - 接口：按项目购买（扣用户 luck，增 stock_user.quantity，更新 item 的 total_quantity / total_value 若需要）。
  - 规则：每当某物品在售股票总价值 &gt; 进货价时，该物品数量 +1（在“出售”或定时任务里判断并更新）。
- **项目废除（数量不足）**
  - 当某项目数量不足 n（由管理端判断或传入阈值）时，可调用废除接口：将该项目下所有观众持仓强制退还（按约定单价如每股 1 幸运值退 luck），并将项目状态置为「已淘汰」；可选清零或归档该项目的 stock_user。

**建议接口**

- **管理端**：`POST /admin/item/batch`（批量创建/更新项目：名称、描述、进货价）
- **管理端**：`POST /admin/item/abolish`（废除项目：传入 item_id；对该项目下所有 stock_user 按约定单价退 luck、更新 user.luck，将 item.status 置为已淘汰，可选清零 stock_user）
- **观众端 - 官方出售**：`PUT /stock/buy`（仅当项目状态为「立项中」时可购买；扣用户 luck、增 stock_user、更新 item 的 total_quantity/total_value；与交易大厅接口隔离）
- **交易大厅**：见 4.2，使用 `/trade/*` 接口，与官方出售完全分离

### 4.2 进行中 - 交易大厅

- **挂卖单**：观众选择项目、单价、数量，扣减其 stock_user.quantity，写入 order（order_type=卖单，remaining=quantity）。
- **挂买单**：观众选择项目、期望单价、数量，写入 order（order_type=买单，remaining=quantity）；预扣 luck，取消时再回退luck。
- **浏览挂单**：分页查询 order（status=挂单中），按 item_id、order_type（卖/买）、价格等筛选。
- **应卖单（买挂单）**：买家选择某卖单，输入购买数量；事务内：扣买家 luck、增买家 stock_user、减卖家 stock_user、减 order.remaining、加卖家 luck、写 trade_record；若 remaining=0 则更新 order.status。
- **应买单（卖挂单）**：卖家选择某买单，输入出售数量；事务内：扣卖家 stock_user、增买家 stock_user、减买家 luck、加卖家 luck、减 order.remaining、写 trade_record；若 remaining=0 则更新 order.status。
- **撤销挂单**：卖单撤销时退还 quantity 到发起人 stock_user；买单撤销时仅更新 status，无资产变动。

**建议接口**

- `PUT /trade/sell`：挂卖单（参数：item_id, price, quantity）
- `PUT /trade/buy`：挂买单（参数：item_id, price, quantity）
- `GET /trade/orders`：列表（item_id、order_type、price 范围、分页）
- `GET /trade/records`：我的成交记录（分页，返回 buyer_id 或 seller_id 为当前用户的记录）
- `PUT /trade/accept`：应单（参数：order_id, quantity；根据 order_type 自动走“买挂单”或“卖挂单”逻辑）
- `PUT /trade/cancel`：撤销自己的挂单（卖单退还 quantity 到 stock_user，买单同理进行相应退还）

### 4.3 进行中 - 投壶与价格计算

- **管理员上传**：一次投壶 = 一条 throw_record（player_pay, total_items）+ 多条 throw_hit（item_id, hit_count）。
- **总价值更新**（在 service 或 method 内一次性完成）：
  - 单项目收益 = player_pay / total_items（整数除法向下取整；若需保留余数可约定按项目顺序分配或文档单独说明）。
  - **对所有项目**（当前在用的全部 item，共 total_items 个）均更新：`new_total_value = old_total_value + 单项目收益 - purchase_price * hit_count`。其中 hit_count 从本次投壶的 throw_hit 中取该 item_id 的命中次数，**未出现在 hits 中的项目 hit_count 视为 0**（即只加分、不减）。
- **注意**：hits 中可只包含“被投中”的项目；未投中的项目仍要加上单项目收益，只需不传或传 hit_count=0。

**建议接口**

- `POST /admin/throw/submit`：提交一次投壶（body: player_pay, total_items, hits: [{item_id, hit_count}]）；服务端写 throw_record + throw_hit，并按上述公式更新**所有项目**的 item.total_value。建议每次玩家结束后再提交（例如该玩家投完 10 次后一次性提交），减少管理员操作频次。

### 4.4 每日结束 - 观众结算

按**项目逐个**结算，避免混算：

- 对每个项目（item）依次处理：
  - 每股价值 = item.total_value / item.total_quantity（总股数；若 total_quantity 为 0 则跳过该项目或按业务约定处理）。
  - 对该项目下所有用户持仓（stock_user where item_id = 该项目）：退还幸运值 = 每股价值 × quantity；user.luck += 退还值。
  - 可选：清零或归档该项目下的 stock_user、写 settlement_detail。
- 再处理下一个项目，直至全部项目结算完毕。

**建议接口**

- `POST /admin/settlement/daily`：触发当日结算，**按项目逐个结算**（遍历每个 item，按上述公式计算并写回 user.luck，

---

## 五、与现有代码的衔接

### 5.1 用户与 ID 约定

- 用户模块已存在；所有新表中外键 user_id 与现有 user 主键一致（若当前为 int 自增，建议统一为雪花 id 的 uint64，前端传 string）。
- 项目/物品、挂单、成交、投壶均使用雪花 ID（uint64），DTO 中 id 以 string 与前端交互。

### 5.2 股票相关现有逻辑

- 现有 `stock`、`stock_user`、`traded_stock` 等：可与“项目 + 交易大厅”做映射：
  - `stock` → 可逐步迁移为“项目维度”的 item（或保留 stock 表，增加 item 表做项目管理）。
  - **官方出售**：使用 `PUT /stock/buy`，仅在项目状态为「立项中」时可购买；与交易大厅路由隔离。
  - **交易大厅**：使用 `/trade/*`（挂单、应单、撤销等），新挂单表 order（支持卖单/买单）+ 成交表 trade_record，与官方出售完全分离。

### 5.3 分层与调用约定

- **Controller (handler)**：只做参数绑定、鉴权上下文，调用 Service，使用 `common.WrapResp(c)(h.xxxService.Method(c, req))` 等形式统一写响应。
- **Service**：编排 method、事务边界、错误码；投壶提交、结算等在一个事务内完成多表更新。
- **Method (dal)**：纯 DB/Redis 操作；如 GetItemByID、UpdateItemTotalValue、CreateOrder、ExecuteTrade 等。

### 5.4 错误码与常量

- 在 `constant/ecode.go` 中新增：项目不存在、挂单不存在、挂单类型不匹配、挂单剩余数量不足、用户持仓不足、余额不足等（与现有 1xx 用户、2xx 股票 约定一致）。

---

## 六、实现顺序建议

1. **数据层**：建表（item、order、trade_record、throw_record、throw_hit），GORM 实体与雪花 ID BeforeCreate；若有旧 stock 表，做迁移或兼容。
2. **赛前**：item 的 CRUD（含名称、描述、进货价）、观众购买项目（扣 luck、更新 item 与 stock_user）。
3. **交易大厅**：挂卖单、挂买单、列表（按 order_type 筛选）、应单（买/卖）、撤销；严格事务与锁，避免超卖。
4. **投壶**：管理员提交接口，总价值更新公式落地，单元测试覆盖公式。
5. **每日结算**：按 item 与 stock_user 计算退还，更新 user.luck，可选结算明细与对账。

---

## 七、风险与注意点

- **并发**：交易大厅购买、赛前抢购需对“挂单剩余数量”“用户持仓”做行锁或乐观锁，防止超卖。
- **精度**：总价值、每股价值、退还金额建议用整数（幸运值最小单位），避免浮点。
- **幂等**：管理员“提交投壶”“触发每日结算”建议支持幂等（如按批次/日期去重），防止重复执行。
- **接口隔离**：官方出售仅用 `PUT /stock/buy`（且限制项目状态为立项中）；交易大厅仅用 `/trade/*`，二者路由与用途分离，不做混用。

以上为基于产品说明的后端实现方案，可直接按模块拆分为任务排期与接口文档细化。
